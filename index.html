<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="referrer" content="unsafe-url">
<title>APM Music Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --bg:#121212; --card:#1e1e1e; --text:#f1f1f1; --accent:#c41f3e; --gray:#888; --red:#ff4444; }
  body { margin:0; font-family:Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; }
  #dropArea { flex:1; border:4px dashed #444; border-radius:12px; margin:20px; display:flex; align-items:center; justify-content:center; font-size:1.5em; cursor:pointer; }
  #dropArea.dragover { border-color:var(--accent); background:#222; }
  #playerContainer { display:none; flex-direction:column; height:100vh; }
  header { padding:15px; background:var(--card); text-align:center; font-size:1.4em; font-weight:bold; }
  .warning { background:#ff4444; color:white; padding:10px; margin:10px; border-radius:8px; text-align:center; font-size:0.9em; }
  .warning a { color:#fff; text-decoration:underline; }
  #playlist { flex:1; overflow-y:auto; padding:8px; }
  .track { background:var(--card); margin:6px 8px; border-radius:8px; overflow:hidden; transition:all 0.3s ease; cursor:pointer; }
  .track:hover { background:#2a2a2a; }
  .track.playing { background:var(--accent); }
  .track.expanded { margin:12px 8px; box-shadow:0 8px 20px #0008; }
  .header { padding:12px 16px; display:flex; align-items:center; gap:12px; font-weight:600; }
  .play-btn { background:none; border:none; color:var(--text); font-size:1.4em; cursor:pointer; width:36px; height:36px; text-align:center; flex-shrink:0; }
  .play-btn:hover { color:var(--accent); }
  .track-info { flex:1; min-width:0; }
  .details { max-height:0; overflow:hidden; transition:max-height 0.4s ease; background:#111; padding:0 16px; }
  .track.expanded .details { max-height:400px; padding:12px 16px; }
  .url { font-family:monospace; font-size:0.8em; word-break:break-all; background:#0004; padding:8px; border-radius:4px; margin:8px 0; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  button { background:var(--accent); color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:0.85em; }
  button:hover { opacity:0.9; }
  .copy { background:#333; }
  .denied { color:var(--red); font-weight:bold; margin:8px 0; }
  .workaround { background:#333; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85em; line-height:1.6; }
  #controls { background:var(--card); padding:12px; text-align:center; }
  #nowPlaying { font-size:1.2em; margin-bottom:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:0 10px; }
  #seekBar { width:100%; height:6px; background:#333; border-radius:3px; outline:none; margin:8px 0; }
  #seekBar::-webkit-slider-thumb { appearance:none; width:16px; height:16px; background:var(--accent); border-radius:50%; cursor:pointer; }
  #time { font-size:0.9em; color:var(--gray); }
  .btns { display:flex; justify-content:center; align-items:center; gap:20px; font-size:1.8em; margin-top:8px; }
  button.big { background:none; border:none; color:var(--text); cursor:pointer; }
  button.big:hover { color:var(--accent); }
  #hiddenFrame { display:none; }
</style>
</head>
<body>

<div id="dropArea">
  Drop your apmID.txt here or click to select
  <input type="file" id="fileInput" accept=".txt" style="display:none">
</div>

<div id="playerContainer">
  <header>APM Music Player</header>
  
  <div class="warning">
    ‚ö†Ô∏è <strong>Referer Issue Detected:</strong> It blocks audio from external sites. 
    <strong>Workaround:</strong> This page must be hosted on a web server (not file://) or use the browser extension method below.
  </div>
  
  <div id="playlist"></div>
  
  <div id="controls">
    <div id="nowPlaying">Drop your apmID.txt to start</div>
    <input type="range" id="seekBar" value="0" min="0" max="100">
    <div id="time">0:00 / 0:00</div>
    <div class="btns">
      <button id="shuffleBtn" class="big" title="Shuffle">üîÄ</button>
      <button id="prevBtn" class="big">‚èÆ</button>
      <button id="playPauseBtn" class="big">‚ñ∂</button>
      <button id="nextBtn" class="big">‚è≠</button>
      <button id="repeatBtn" class="big" title="Repeat">üîÅ</button>
    </div>
  </div>
</div>

<!-- Hidden iframe to trick referer -->
<iframe id="hiddenFrame" src="about:blank"></iframe>
<audio id="audio" preload="metadata"></audio>

<script>
let tracks = [];
let currentIndex = 0;
let shuffle = false;
let repeatMode = 0;
let loadedTrackIndex = -1;
const audio = document.getElementById('audio');
const playlistDiv = document.getElementById('playlist');
const dropArea = document.getElementById('dropArea');

// ==================== FILE LOADER ====================
dropArea.addEventListener('click', () => document.getElementById('fileInput').click());

document.getElementById('fileInput').addEventListener('change', function(e) {
  if (this.files[0]) handleFile(this.files[0]);
});

dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
dropArea.addEventListener('drop', e => {
  e.preventDefault();
  dropArea.classList.remove('dragover');
  if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    extractTracks(e.target.result);
    if (tracks.length > 0) {
      dropArea.style.display = 'none';
      document.getElementById('playerContainer').style.display = 'flex';
      renderPlaylist();
      loadTrack(0);
    } else {
      alert('No tracks found! Make sure you dropped a valid APM search results page saved as .txt');
    }
  };
  reader.readAsText(file);
}

// ==================== EXTRACT TRACKS ====================
function extractTracks(html) {
  tracks = [];
  const seen = new Set();
  const doc = new DOMParser().parseFromString(html, 'text/html');
  doc.querySelectorAll('[data-musicid]').forEach(row => {
    const id = row.getAttribute('data-musicid');
    if (!id || seen.has(id)) return;
    const titleEl = row.querySelector('h2');
    const durEl = row.querySelector('[data-testid="serp-duration"]');
    if (!titleEl || !durEl) return;

    seen.add(id);
    const [lib, , albumNum] = id.split('_');
    const albumCode = `${lib}_${lib}_${albumNum}`;
    const url = `https://audio.prod.apmmusic.com/mp3_128/${lib}/${lib}/${albumCode}/${id}.mp3`;

    tracks.push({
      id,
      title: titleEl.textContent.trim(),
      duration: durEl.textContent.trim(),
      url,
      denied: false
    });
  });
}

// ==================== RENDER PLAYLIST ====================
function renderPlaylist() {
  playlistDiv.innerHTML = '';
  tracks.forEach((t, i) => {
    const div = document.createElement('div');
    div.className = 'track';
    div.innerHTML = `
      <div class="header">
        <button class="play-btn" onclick="playThis(${i}); event.stopPropagation();">‚ñ∂</button>
        <div class="track-info">${i+1}. ${t.title} <span style="color:#666; font-weight:normal;">(${t.duration})</span></div>
      </div>
      <div class="details">
        ${t.denied ? '<div class="denied">‚õî Access Denied by APM - Referer Check Failed</div>' : ''}
        ${t.denied ? `
          <div class="workaround">
            <strong>Workarounds to fix this:</strong><br>
            1. <strong>Browser Extension:</strong> Install <a href="https://chromewebstore.google.com/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj" target="_blank" style="color:#4af">ModHeader</a> 
            ‚Üí Add header: <code>Referer: https://www.apmmusic.com/</code><br>
            2. <strong>Open directly:</strong> <button class="copy" onclick="window.open('${t.url}'); event.stopPropagation();">Open in New Tab</button><br>
            3. <strong>Download via curl:</strong> <code style="font-size:0.75em; display:block; margin:4px 0;">curl "${t.url}" -H "Referer: https://www.apmmusic.com/" -o song.mp3</code>
          </div>
        ` : ''}
        <div class="url">${t.url}</div>
        <div class="actions">
          <button class="copy" onclick="copyUrl('${t.url}'); event.stopPropagation();">Copy URL</button>
          <button onclick="openInNewTab('${t.url}'); event.stopPropagation();">Open Direct</button>
          <button onclick="copyCurl('${t.url}', '${t.title.replace(/'/g,"")}'); event.stopPropagation();">Copy curl Command</button>
        </div>
      </div>
    `;
    div.onclick = () => div.classList.toggle('expanded');
    playlistDiv.appendChild(div);
  });
}

function playThis(i) {
  loadTrack(i);
  audio.play().catch(err => {
    console.error('Play error:', err);
    tracks[currentIndex].denied = true;
    renderPlaylist();
    document.querySelectorAll('.track')[currentIndex].classList.add('expanded');
  });
  document.getElementById('playPauseBtn').textContent = '‚è∏';
}

function copyUrl(u) { 
  navigator.clipboard.writeText(u); 
  alert('‚úÖ URL copied to clipboard!'); 
}

function openInNewTab(url) {
  window.open(url, '_blank');
}

function copyCurl(url, title) {
  const cmd = `curl "${url}" -H "Referer: https://www.apmmusic.com/" -o "${title.replace(/[^a-z0-9]/gi, '_')}.mp3"`;
  navigator.clipboard.writeText(cmd);
  alert('‚úÖ curl command copied! Paste in terminal to download.');
}

// ==================== PLAYER CORE ====================
function loadTrack(i) {
  currentIndex = i < 0 ? tracks.length-1 : i % tracks.length;
  
  if (loadedTrackIndex !== currentIndex) {
    const t = tracks[currentIndex];
    document.getElementById('nowPlaying').textContent = `${currentIndex+1}/${tracks.length} ‚Äì ${t.title}`;
    
    // Try to load with various methods
    audio.src = t.url;
    audio.load();
    loadedTrackIndex = currentIndex;

    audio.onerror = () => {
      tracks[currentIndex].denied = true;
      renderPlaylist();
      document.querySelectorAll('.track')[currentIndex].classList.add('expanded');
      
      // Auto-skip to next track
      setTimeout(() => {
        if (currentIndex < tracks.length - 1) {
          loadTrack(currentIndex + 1);
          audio.play().catch(err => console.error('Auto-skip play error:', err));
        }
      }, 1000);
    };
  }

  updateHighlight();
}

function updateHighlight() {
  document.querySelectorAll('.track').forEach((el, i) => el.classList.toggle('playing', i === currentIndex));
}

// Controls
document.getElementById('playPauseBtn').onclick = () => {
  if (audio.paused) { 
    audio.play().catch(err => {
      console.error('Play error:', err);
      tracks[currentIndex].denied = true;
      renderPlaylist();
      document.querySelectorAll('.track')[currentIndex].classList.add('expanded');
    }); 
    document.getElementById('playPauseBtn').textContent = '‚è∏'; 
  } else { 
    audio.pause(); 
    document.getElementById('playPauseBtn').textContent = '‚ñ∂'; 
  }
};

document.getElementById('nextBtn').onclick = () => { 
  loadTrack(currentIndex + 1); 
  audio.play().catch(err => console.error('Play error:', err)); 
};

document.getElementById('prevBtn').onclick = () => { 
  loadTrack(currentIndex - 1); 
  audio.play().catch(err => console.error('Play error:', err)); 
};

// Shuffle
document.getElementById('shuffleBtn').onclick = () => {
  shuffle = !shuffle;
  document.getElementById('shuffleBtn').style.color = shuffle ? 'var(--accent)' : 'var(--text)';
};

// Repeat
document.getElementById('repeatBtn').onclick = () => {
  repeatMode = (repeatMode + 1) % 3;
  const btn = document.getElementById('repeatBtn');
  if (repeatMode === 0) btn.textContent = 'üîÅ';
  else if (repeatMode === 1) btn.textContent = 'üîÇ';
  else btn.textContent = 'üîÇ';
  btn.style.color = repeatMode > 0 ? 'var(--accent)' : 'var(--text)';
};

// Seek bar
const seek = document.getElementById('seekBar');
audio.ontimeupdate = () => {
  if (audio.duration) {
    seek.value = (audio.currentTime / audio.duration) * 100;
    document.getElementById('time').textContent = fmt(audio.currentTime) + ' / ' + fmt(audio.duration);
  }
};
seek.oninput = () => audio.currentTime = (seek.value / 100) * audio.duration;
function fmt(s) { const m = Math.floor(s/60); const ss = Math.floor(s%60); return `${m}:${ss<10?'0':''}${ss}`; }

audio.onended = () => {
  if (repeatMode === 2) {
    audio.currentTime = 0;
    audio.play().catch(err => console.error('Repeat error:', err));
  } else if (repeatMode === 1 || currentIndex < tracks.length-1) { 
    loadTrack(shuffle ? Math.floor(Math.random() * tracks.length) : currentIndex + 1); 
    audio.play().catch(err => console.error('Next track error:', err)); 
  }
};
</script>
</body>
</html>
